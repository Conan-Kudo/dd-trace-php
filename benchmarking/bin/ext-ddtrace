#!/bin/bash

source $(dirname $(readlink -f $0))/env-config

TRACER_VERSION=$2
if [ -z "${TRACER_VERSION}" ]; then
    echo "Please specify a tracer version" && exit 1
fi

mkdir -p /src/ddtrace-downloads && cd $_

if [ "${TRACER_VERSION}" = "local" ]; then
    rm -Rf ./dd-trace-php-local && mkdir $_ && cd $_ \
        && tar --exclude="*.lo" -czf local.tar.gz  -C /src/ddtrace bridge src config.m4 \
        && tar -xzf local.tar.gz && rm local.tar.gz
        # The idea was to allow PHP changes without recompiling the extension,
        # by symlinking to the PHP scripts. But since the Docker-to-Macos
        # filesystem is slow, symlinking would skew the benchmark results.
        #&& ln -s /src/ddtrace/bridge ./bridge \
        #&& ln -s /src/ddtrace/src/DDTrace ./src/DDTrace
else
    wget --quiet https://github.com/DataDog/dd-trace-php/archive/${TRACER_VERSION}.tar.gz \
        && rm -Rf dd-trace-php-${TRACER_VERSION} \
        && tar -xzf ${TRACER_VERSION}.tar.gz \
        && rm ${TRACER_VERSION}.tar.gz \
        && cd dd-trace-php-${TRACER_VERSION}
fi

${BIN_DIR}/phpize \
    && ./configure \
        --enable-ddtrace \
        --with-php-config=${BIN_DIR}/php-config \
    && make -j$(nproc) \
    && mkdir -p ${BASE_PHP_DIR}/lib/php/extensions/ddtrace-${TRACER_VERSION}/ \
    && cp modules/ddtrace.so $_ \
    && printf "\nüê∂ ddtrace ${TRACER_VERSION} for PHP ${PHP_VERSION} compiled successfully - WOOF!\n"
